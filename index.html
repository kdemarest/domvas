<html>
<head>
<meta charset="utf-8"/>

<link rel="stylesheet" type="text/css" href="minireset.css">
<link rel="stylesheet" type="text/css" href="index.css">

<script src="jquery.3.3.1.js" charset="utf-8"></script>
<script src="utilModule.js" charset="utf-8"></script>

<script src="utilities.js" charset="utf-8"></script>
<script src="time.js" charset="utf-8"></script>
<script src="gui.js" charset="utf-8"></script>

<script src="visual.js" charset="utf-8"></script>
<script src="panelProductivity.js" charset="utf-8"></script>

<script>
Module.realize();

class VisualDataSource {
	constructor() {
	}
	update() {
	}
}

class ProductivityData extends VisualDataSource {
	constructor() {
		super();
		this.wellbeingIconHash = {
			food:	'icons/food.png',
			water:	'icons/water.png',	
			rest:	'icons/rest.png',
			health:	'icons/health.png'
		}
		this.init();
		this.update();
	}
	init() {
		this.food = -0.2;
		this.water = 0.0;
		this.rest = -0.1;
		this.health = 0.0;
		this.skill = 1.2;
		this.morale = -0.3;
		this.wellbeing = this[this.wellbeingLeast];
		this.gear = 0;
		this.venue = 0;
		return this;
	}
	update() {
		this.wellbeing = this[this.wellbeingLeast];
		return this;
	}
	totals(index) {
		console.assert( index >=0 && index <=4 );
		return [
			this.skill,
			this.skill+this.morale,
			this.skill+this.morale+this.wellbeing,
			this.skill+this.morale+this.wellbeing+this.gear,
			this.skill+this.morale+this.wellbeing+this.gear+this.venue
		][index];
	}
	get wellbeingLeast() {
		let least = 'food';
		least = this.water  < this[least] ? 'water'  : least;
		least = this.rest   < this[least] ? 'rest'   : least;
		least = this.health < this[least] ? 'health' : least;
		return least;
	}
	get wellbeingIcon() {
		return this.wellbeingIconHash[this.wellbeingLeast];
	}
};

function createPanelProductivity(rootDiv,data) {
	let root = new Visual.Canvas(rootDiv,ProductivityPanelLayout,data);
	let layout = root.layout;

	// everything gets a layout fun, so...
	let visual = root.addVisualHash({
		skill:		[ new Visual.Sprite('icons/skill.png'),		(v) => layout.xLegend(v,0) ],
		morale: 	[ new Visual.Sprite('icons/morale.png'),	(v) => layout.xLegend(v,1) ],
		wellbeing:	[ new Visual.Sprite(null),					(v) => { layout.xLegend(v,2); v.image=data.wellbeingIcon; } ],
		gear:		[ new Visual.Sprite('icons/goods.png'),		(v) => layout.xLegend(v,3) ],
		household:	[ new Visual.Sprite('icons/household.png'),	(v) => layout.xLegend(v,4) ],
		production:	[ new Visual.Sprite('icons/production.png'),(v) => layout.xLegend(v,5.5,1.3) ],

		L0:			[ new Visual.Line('white',2),	(v) => layout.line(v,0) ],
		L1:			[ new Visual.Line('gray',1),	(v) => layout.line(v,1) ],
		L2:			[ new Visual.Line('gray',1),	(v) => layout.line(v,2) ],

		title:		[ new Visual.Text('white','Production'), (v) => layout.title(v) ],

		yL0:		[ new Visual.Text('white','0x'), (v) => layout.yLegend(v,0) ],
		yL1:		[ new Visual.Text('white','1x'), (v) => layout.yLegend(v,1) ],
		yL2:		[ new Visual.Text('white','2x'), (v) => layout.yLegend(v,2) ],

		b0:			[ new Visual.Sprite(null), (v) => layout.bar(v,0,1, 0.0,data.totals(0) ) ],
		b1:			[ new Visual.Sprite(null), (v) => layout.bar(v,1,1, data.totals(0),data.totals(1) ) ],
		b2:			[ new Visual.Sprite(null), (v) => layout.bar(v,2,1, data.totals(1),data.totals(2) ) ],
		b3:			[ new Visual.Sprite(null), (v) => layout.bar(v,3,1, data.totals(2),data.totals(3) ) ],
		b4:			[ new Visual.Sprite(null), (v) => layout.bar(v,4,1, data.totals(3),data.totals(4) ) ],
		b5:			[ new Visual.Sprite(null), (v) => layout.bar(v,5.5,1.3, 0.0,data.totals(4), false) ]
	});

	visual.skill.link('iconButton')
		.on('click',()=>{})
	;
	visual.morale.link('iconButton')
		.on('click',()=>{})
	;
	visual.wellbeing.link('iconButton')
		.on('click',()=>{ 
			data.rest -= 0.1;
		})
	;
	visual.gear.link('iconButton')
		.on('click',()=>{})
	;
	visual.household.link('iconButton')
		.on('click',()=>{})
	;

	return root;
}


function onResize() {
	Gui.layout({
		'#guiMain': {
			height: self => $('body').height() - self.offset().top - parseInt(self.css('margin-bottom'))
		},
		'#drawingArea': {
			height: self => $('#guiMain').height()
		}
	});
}

function main() {
	let data = new ProductivityData();
	let root = createPanelProductivity('drawingArea',data);
	window.addEventListener('resize', onResize );
	onResize();

	setTimeout( ()=>{
		let event = new Event('resize');
		window.dispatchEvent(event);
	}, 100 );

	Time.animationFrameTicker( dt => {
		root.tick(dt);
		root.render();
	});
}

</script>



</head>
<body style='overflow-x: hidden; overflow-y: hidden;'>
	<div id="guiMain" style="position: absolute; width: 600px; margin:30px;">
		<div id="drawingArea">
		</div>
	</div>
	<script>
	document.addEventListener("DOMContentLoaded", () => {
		main();
	})
	</script>

</body>
</html>
